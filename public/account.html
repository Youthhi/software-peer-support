<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Student Dashboard - Peer Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-cyan-300 via-blue-400 to-indigo-600">

    <div class="max-w-6xl mx-auto flex py-10 px-4 gap-8">
        <aside class="w-1/4 bg-white rounded-xl shadow-2xl p-6 h-fit">
            <div class="flex items-center gap-4 mb-6">
                <a href="/mainpage" class="p-2 hover:bg-gray-100 rounded-full transition-colors group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600 group-hover:text-blue-600"
                        fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </a>
                <h2 class="text-2xl font-bold text-gray-800">Dashboard</h2>
            </div>

            <h3 class="font-bold text-xl mb-6 text-gray-700 border-b pb-2">Settings</h3>
            <nav class="space-y-2">
                <button onclick="showSection('personal')"
                    class="nav-btn w-full text-left p-3 hover:bg-blue-50 rounded-lg text-blue-600 font-bold border-l-4 border-blue-600 transition-all">üë§
                    Personal Details</button>
                <button onclick="showSection('counselor')"
                    class="nav-btn w-full text-left p-3 hover:bg-gray-50 rounded-lg text-gray-600 transition-all">üìÖ
                    Available Timetable</button>
                <button onclick="showSection('security')"
                    class="nav-btn w-full text-left p-3 hover:bg-gray-50 rounded-lg text-gray-600 transition-all">üîí
                    Privacy & Security</button>
                <button onclick="showSection('apply')"
                    class="nav-btn w-full text-left p-3 hover:bg-gray-50 rounded-lg text-gray-600 transition-all">üë®‚Äçüè´
                    Become Moderator</button>

                <button id="logoutBtn"
                    class="w-full text-left p-3 hover:bg-red-50 rounded-lg text-red-600 mt-10 font-medium">üö™ Log
                    Out</button>
            </nav>
        </aside>

        <main id="mainContent" class="w-3/4 bg-white rounded-xl shadow-2xl p-8 min-h-[600px]">

            <section id="personalSection">
                <h2 class="text-2xl font-bold mb-6">Edit Personal Details</h2>
                <form id="detailsForm" class="grid grid-cols-2 gap-6">
                    <div class="col-span-2 flex items-center gap-6 pb-6 border-b">
                        <div class="relative">
                            <img id="profilePreview" src="https://via.placeholder.com/150"
                                class="w-24 h-24 rounded-full object-cover border-4 border-blue-100 shadow-sm">
                            <label for="fileInput"
                                class="absolute bottom-0 right-0 bg-blue-600 text-white p-2 rounded-full cursor-pointer hover:scale-110 transition-transform shadow-lg">üì∏</label>
                            <input type="file" id="fileInput" class="hidden" accept="image/*">
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800">Profile Photo</h4>
                            <p class="text-sm text-gray-500">Update your avatar for counselors to see.</p>
                        </div>
                    </div>

                    <div class="col-span-2">
                        <label class="block text-sm font-bold text-gray-700 mb-1">Bio</label>
                        <textarea id="bio" rows="3"
                            class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="Write a short intro..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Full Name</label>
                        <input type="text" id="fullName" class="w-full border p-3 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" class="w-full border p-3 rounded-lg bg-gray-50 text-gray-500"
                            readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Hobby</label>
                        <input type="text" id="hobby" class="w-full border p-3 rounded-lg">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">Gender</label>
                        <select id="gender" class="w-full border p-3 rounded-lg">
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="col-span-2 flex items-center gap-4 pt-4 border-t">
                        <button type="submit" id="saveProfileBtn"
                            class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold hover:bg-blue-700 shadow-md">Save
                            Changes</button>
                        <p id="confirmMsg" class="text-green-600 font-bold hidden">‚úÖ Profile Updated!</p>
                    </div>
                </form>
            </section>

            <section id="counselorSection" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Counselor Availability</h2>
                        <p class="text-gray-500 text-sm">Select a counselor and time slot to book a session.</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <label class="text-xs font-bold text-gray-500 uppercase mb-1">Filter by Date</label>
                        <input type="date" id="filterDate"
                            class="border p-2 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="overflow-hidden border border-gray-200 rounded-xl shadow-sm">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase">Counselor</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase">Date</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase">Time Slot</th>
                                <th class="p-4 text-xs font-bold text-gray-500 uppercase text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody id="counselorTimetable" class="divide-y divide-gray-100 bg-white">
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

    <div id="timetableModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col overflow-hidden">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h3 id="modalCounsellorName" class="text-xl font-bold text-gray-800">Counsellor Schedule</h3>
                    <p class="text-sm text-gray-500">Select a time block to book your session.</p>
                </div>
                <button onclick="closeModal()"
                    class="text-3xl text-gray-400 hover:text-gray-600 transition-colors">&times;</button>
            </div>

            <div class="p-6 overflow-auto custom-scroll">
                <div class="grid grid-cols-[100px_repeat(13,minmax(70px,1fr))] gap-y-1 min-w-[1050px]">

                    <div class="h-10 bg-white sticky top-0 z-10"></div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        8am</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        9am</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        10am</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        11am</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        12pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        1pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        2pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        3pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        4pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        5pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        6pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        7pm</div>
                    <div
                        class="text-center text-[10px] font-bold text-blue-600 uppercase border-b pb-2 sticky top-0 bg-white z-10">
                        8pm</div>

                    <div id="modalGridBody" class="contents"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        /* ===================== FIREBASE IMPORTS ===================== */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import {
          getFirestore,
          doc,
          getDoc,
          updateDoc,
          getDocs,
          collection,
          addDoc,
          serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        /* ===================== FIREBASE CONFIG ===================== */
        const firebaseConfig = {
          apiKey: "AIzaSyAlpEfar5odDfV9c2bbmaIpAt5fJJfbez4",
          authDomain: "software-peer-support.firebaseapp.com",
          projectId: "software-peer-support",
          storageBucket: "software-peer-support.firebasestorage.app",
          messagingSenderId: "43088815786",
          appId: "1:43088815786:web:4332760b0fef1b7ae152d3"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        /* ===================== STUDENT SESSION ===================== */
        const uid = sessionStorage.getItem("uid") || localStorage.getItem("uid");
        if (!uid) window.location.href = "/register";
        
        /* ===================== NAVIGATION ===================== */
        window.showSection = (section) => {
          const sections = ["personal", "counselor", "security", "apply"];
          sections.forEach(s => {
            const el = document.getElementById(`${s}Section`);
            if (el) el.classList.add("hidden");
          });
        
          document.getElementById(`${section}Section`).classList.remove("hidden");
        
          document.querySelectorAll(".nav-btn").forEach(btn => {
            btn.classList.remove("text-blue-600", "font-bold", "border-l-4", "border-blue-600", "bg-blue-50");
            btn.classList.add("text-gray-600");
          });
        
          if (section === "counselor") loadCounsellors();
        };
        
        /* ===================== PROFILE ===================== */
        async function loadProfile() {
          const snap = await getDoc(doc(db, "students", uid));
          if (!snap.exists()) return;
        
          const d = snap.data();
          document.getElementById("fullName").value = `${d.firstName || ""} ${d.lastName || ""}`;
          document.getElementById("email").value = d.email || "";
          document.getElementById("bio").value = d.bio || "";
          document.getElementById("hobby").value = d.hobby || "";
          document.getElementById("gender").value = d.gender || "Male";
          if (d.profilePic) document.getElementById("profilePreview").src = d.profilePic;
        }
        
        document.getElementById("detailsForm").addEventListener("submit", async (e) => {
          e.preventDefault();
        
          const [firstName, ...rest] = document.getElementById("fullName").value.split(" ");
          const lastName = rest.join(" ");
        
          await updateDoc(doc(db, "students", uid), {
            firstName,
            lastName,
            bio: document.getElementById("bio").value,
            hobby: document.getElementById("hobby").value,
            gender: document.getElementById("gender").value,
            profilePic: document.getElementById("profilePreview").src,
            updatedAt: serverTimestamp()
          });
        
          document.getElementById("confirmMsg").classList.remove("hidden");
          setTimeout(() => document.getElementById("confirmMsg").classList.add("hidden"), 3000);
        });
        
        /* ===================== COUNSELLOR LIST ===================== */
        async function loadCounsellors() {
          const tbody = document.getElementById("counselorTimetable");
          tbody.innerHTML = `<tr><td colspan="4" class="p-6 text-center text-gray-400">Loading...</td></tr>`;
        
          const snap = await getDocs(collection(db, "counsellors"));
          tbody.innerHTML = "";
        
          snap.forEach(docSnap => {
            const c = docSnap.data();
            tbody.innerHTML += `
              <tr class="border-b hover:bg-blue-50">
                <td class="p-4 flex items-center gap-3">
                  <img src="${c.profilePic || "https://via.placeholder.com/40"}" class="w-10 h-10 rounded-full border">
                  <div>
                    <p class="font-bold">${c.firstName} ${c.lastName}</p>
                    <p class="text-xs text-blue-500">${c.qualification || "Counsellor"}</p>
                  </div>
                </td>
                <td class="p-4 text-sm">Weekly</td>
                <td class="p-4 text-sm text-center">‚Äî</td>
                <td class="p-4 text-center">
                  <button onclick="openTimetable('${docSnap.id}', '${c.firstName} ${c.lastName}')"
                    class="bg-indigo-600 text-white px-4 py-2 rounded text-xs hover:bg-indigo-700">
                    Book
                  </button>
                </td>
              </tr>
            `;
          });
        }
        
        /* ===================== TIMETABLE MODAL ===================== */
        window.openTimetable = async (counsellorId, name) => {
          document.getElementById("modalCounsellorName").innerText = name;
          const grid = document.getElementById("modalGridBody");
          grid.innerHTML = "";
        
          const snap = await getDoc(doc(db, "counsellors", counsellorId));
          if (!snap.exists()) return;
        
          const slots = snap.data().availability || [];
          const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
          const hours = ["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00"];
        
          days.forEach(day => {
            grid.innerHTML += `<div class="font-bold text-sm bg-gray-50 p-2">${day}</div>`;
        
            hours.forEach(time => {
              const match = slots.find(s => s.from === time &&
                new Date(s.date).toLocaleDateString("en-US",{weekday:"long"}) === day
              );
        
              grid.innerHTML += match
                ? `<button onclick="confirmBooking('${name}','${match.date}','${time}')"
                     class="h-10 bg-indigo-50 hover:bg-indigo-600 hover:text-white text-xs rounded border">
                     BOOK
                   </button>`
                : `<div class="h-10 bg-gray-100 rounded"></div>`;
            });
          });
        
          document.getElementById("timetableModal").classList.remove("hidden");
        };
        
        window.closeModal = () => {
          document.getElementById("timetableModal").classList.add("hidden");
        };
        
        /* ===================== BOOKING ===================== */
        window.confirmBooking = async (counsellor, date, time) => {
          if (!confirm(`Request session with ${counsellor} on ${date} at ${time}?`)) return;
        
          await addDoc(collection(db, "bookingRequests"), {
            studentUid: uid,
            counsellorName: counsellor,
            date,
            time,
            status: "pending",
            createdAt: serverTimestamp()
          });
        
          alert("Request sent!");
          closeModal();
        };
        
        /* ===================== LOGOUT ===================== */
        document.getElementById("logoutBtn").onclick = () => {
          sessionStorage.clear();
          localStorage.clear();
          window.location.href = "/register";
        };
        
        /* ===================== INIT ===================== */
        loadProfile();
        </script>
        
</body>

</html>