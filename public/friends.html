<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Friends</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50 px-6 py-4">
        <div class="max-w-3xl mx-auto flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">My Friends</h1>
            <a href="mainpage.html" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition">
                Back to Home
            </a>
        </div>
    </nav>

    <div class="max-w-3xl mx-auto p-6">
        <div id="friendsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <p class="text-gray-400 text-center col-span-full py-10">Loading friends...</p>
        </div>
    </div>

    <script type="module">
        // 1. ADDED deleteDoc to the imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlpEfar5odDfV9c2bbmaIpAt5fJJfbez4",
            authDomain: "software-peer-support.firebaseapp.com",
            projectId: "software-peer-support",
            storageBucket: "software-peer-support.firebasestorage.app",
            messagingSenderId: "43088815786",
            appId: "1:43088815786:web:4332760b0fef1b7ae152d3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = localStorage.getItem("uid") || sessionStorage.getItem("uid");
        const role = localStorage.getItem("role") || sessionStorage.getItem("role");

        // 2. FIXED FUNCTION: Added the missing deleteDoc calls
        window.removeFriend = async (friendId) => {
            if (!confirm("Are you sure you want to remove this friend?")) return;

            try {
                const myCol = (role === "student") ? "students" : (role + "s");

                // Find which collection the target friend is in
                let targetCol = "students";
                const cols = ["students", "counsellors", "admins"];
                for (const c of cols) {
                    const snap = await getDoc(doc(db, c, friendId));
                    if (snap.exists()) { targetCol = c; break; }
                }

                // --- THE FIX: Actually delete from BOTH users ---
                await deleteDoc(doc(db, myCol, uid, "friends", friendId));
                await deleteDoc(doc(db, targetCol, friendId, "friends", uid));

                alert("Friend removed.");
            } catch (error) {
                console.error("Error removing friend:", error);
                alert("Failed to remove friend.");
            }
        };

        if (!uid) {
            window.location.href = "index.html";
        } else {
            const myCol = (role === "student") ? "students" : (role + "s");
            const friendsRef = collection(db, myCol, uid, "friends");

            onSnapshot(friendsRef, async (snapshot) => {
                const list = document.getElementById("friendsList");
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="col-span-full text-center py-20 bg-white rounded-2xl border-2 border-dashed">
                            <p class="text-gray-500">No friends added yet.</p>
                        </div>`;
                    return;
                }
        
// Change this part in your map function:
const friendCards = await Promise.all(snapshot.docs.map(async (friendDoc) => {
    const friendId = friendDoc.id;
    
    // EXTRA PROTECTION: 
    // Ensure we are fetching the OTHER person's data, not the logged-in user
    if (friendId === uid) {
        console.log("Found myself in the list, skipping...");
        return null; 
    }

    let fData = null;
    for (const col of ["students", "counsellors", "admins"]) {
        const profileSnap = await getDoc(doc(db, col, friendId));
        if (profileSnap.exists()) {
            fData = profileSnap.data();
            fData.id = friendId; 
            break;
        }
    }
    return fData;
}));

            // Filter out any nulls and render
            friendCards.filter(f => f !== null).forEach(friend => {
                const name = `${friend.firstName || friend.adminName || ''} ${friend.lastName || ''}`;
                const card = document.createElement("div");
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition";
                
                card.innerHTML = `
                    <div class="flex items-center gap-4 cursor-pointer flex-1" onclick="window.location.href='profile.html?id=${friend.id}'">
                        <img src="${friend.profilePic || 'https://via.placeholder.com/50'}" 
                             class="w-12 h-12 rounded-full object-cover border border-gray-200">
                        <div>
                            <h3 class="font-bold text-gray-800">${name}</h3>
                            <p class="text-xs text-green-500 font-medium capitalize">${friend.role || 'Connected'}</p>
                        </div>
                    </div>
                    <button onclick="window.removeFriend('${friend.id}')" 
                            class="ml-4 px-3 py-1 text-xs font-semibold text-red-500 hover:bg-red-50 rounded-lg border border-red-200 transition">
                        Remove
                    </button>
                `;
                list.appendChild(card);
            });
        });
    }
</script>
</body>
</html>