<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Main Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gradient-to-br from-cyan-300 via-blue-400 to-indigo-600">

  <!-- ===================== TOP NAV ===================== -->
  <nav class="flex items-center justify-between bg-white/80 backdrop-blur px-6 py-4 shadow sticky top-0 z-40">

    <!-- Settings Button -->
    <div id="settingsBtn"
      class="w-10 h-10 flex items-center justify-center rounded-full bg-gray-200 cursor-pointer hover:bg-gray-300">
      ‚öôÔ∏è
    </div>

    <!-- Search -->
    <div class="max-w-md mx-auto relative">
      <div class="relative group">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
          <svg class="w-5 h-5 text-gray-400 group-focus-within:text-blue-600" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </span>
        <input type="text" id="searchInput"
          class="w-full py-2.5 pl-10 pr-4 bg-gray-100 rounded-lg focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none"
          placeholder="Search accounts...">
      </div>

      <!-- Search Results -->
      <div id="searchResults" class="absolute z-50 w-full mt-2 bg-white rounded-xl shadow border hidden">
        <div id="resultsList" class="max-h-60 overflow-y-auto"></div>
      </div>
    </div>
  </nav>

  <!-- ===================== MAIN DASHBOARD ===================== -->
  <div class="max-w-7xl mx-auto px-6 my-10 space-y-6
              bg-white/30 backdrop-blur-lg rounded-3xl p-8">

    <!-- Forums - Full Width -->
    <div onclick="location.href='forums.html'" class="cursor-pointer bg-blue-50 hover:bg-blue-100
                rounded-2xl shadow hover:shadow-xl transition
                p-28 flex items-center justify-between">
      <div>
        <h2 class="text-7xl font-bold text-blue-900">üó£Ô∏è Forums</h2>
        <p class="text-xl text-blue-700 mt-2 max-w-2xl">
          Discuss topics, ask questions, and share experiences with the community
        </p>
      </div>
      <span class="text-blue-400 text-4xl">‚Ä∫</span>
    </div>

    <!-- Bottom Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- Chats -->
      <div onclick="location.href='chats.html'" class="cursor-pointer bg-green-50 hover:bg-green-100
                  rounded-2xl shadow hover:shadow-xl transition
                  p-28 flex flex-col justify-between min-h-[180px]">
        <div>
          <h2 class="text-5xl font-bold text-green-900">üí¨ Chats</h2>
          <p class="text-green-700 mt-2">
            Private and group chats with peers and counsellors
          </p>
        </div>
        <span class="text-green-400 text-3xl self-end">‚Ä∫</span>
      </div>

      <!-- Mini Games -->
      <div onclick="location.href='minigames.html'" class="cursor-pointer bg-purple-50 hover:bg-purple-100
                  rounded-2xl shadow hover:shadow-xl transition
                  p-28 flex flex-col justify-between min-h-[180px]">
        <div>
          <h2 class="text-5xl font-bold text-purple-900">üéÆ Mini Games</h2>
          <p class="text-purple-700 mt-2">
            Relax and reduce stress with fun mini games
          </p>
        </div>
        <span class="text-purple-400 text-3xl self-end">‚Ä∫</span>
      </div>

    </div>
  </div>

  <!-- ===================== SIDEBAR ===================== -->
  <div id="sidebar"
    class="fixed top-0 left-0 w-72 h-full bg-white shadow-xl transform -translate-x-full transition-transform duration-300 z-50">
    <div class="p-6 border-b">
      <p class="text-sm text-gray-500">Account</p>
      <p id="sidebarUserName" class="font-semibold text-gray-800">Loading...</p>
    </div>
    <ul class="p-4 space-y-2">
      <li><a href="/notifications" class="block px-3 py-2 rounded hover:bg-gray-100">üîî Notifications</a></li>
      <li><a href="/achievements" class="block px-3 py-2 rounded hover:bg-gray-100">üèÜ Achievements</a></li>
      <li>
        <a id="accountLink" href="#" class="block px-3 py-2 rounded hover:bg-gray-100">
          ‚öôÔ∏è Manage Account
        </a>
      </li>
      
    </ul>
  </div>
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-30 hidden z-40"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const accountLink = document.getElementById("accountLink");
      const role = sessionStorage.getItem("role") || localStorage.getItem("role") || "student";
    
      const accountPages = {
        student: "/account",
        counsellor: "/counsellor-account",
        moderator: "/moderator-account",
        admin: "/admin-account"
      };
    
      accountLink.href = accountPages[role] || "/account";
    });
    </script>
    

  <!-- ===================== SIDEBAR SCRIPT ===================== -->
  <script>
    const settingsBtn = document.getElementById("settingsBtn");
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("overlay");

    settingsBtn.addEventListener("click", () => {
      sidebar.classList.toggle("-translate-x-full");
      overlay.classList.toggle("hidden");
    });

    overlay.addEventListener("click", () => {
      sidebar.classList.add("-translate-x-full");
      overlay.classList.add("hidden");
    });
  </script>

  <!-- ===================== FIREBASE + SEARCH + REMOVE ===================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAlpEfar5odDfV9c2bbmaIpAt5fJJfbez4",
      authDomain: "software-peer-support.firebaseapp.com",
      projectId: "software-peer-support",
      storageBucket: "software-peer-support.firebasestorage.app",
      messagingSenderId: "43088815786",
      appId: "1:43088815786:web:4332760b0fef1b7ae152d3"
    };

    // 2. Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 3. Search Bar Elements
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');
    const resultsList = document.getElementById('resultsList');

    // Role check
    const role = sessionStorage.getItem("role") || localStorage.getItem("role");

    // 4. Search Functionality
    searchInput.addEventListener('input', async (e) => {
      const term = e.target.value.toLowerCase().trim();
      const myUid = sessionStorage.getItem("uid") || localStorage.getItem("uid");

      if (!term) {
        searchResults.classList.add('hidden');
        return;
      }

      try {
        const querySnapshot = await getDocs(collection(db, "students"));
        const matches = [];

        querySnapshot.forEach((docSnap) => {
          const userId = docSnap.id;
          if (userId === myUid) return;

          const user = docSnap.data();
          const fullName = `${user.firstName || ''} ${user.lastName || ''}`.toLowerCase();
          if (fullName.includes(term)) matches.push({ id: userId, ...user });
        });

        renderResults(matches);
      } catch (err) {
        console.error("Search error:", err);
      }
    });

    // Render search results
    function renderResults(users) {
      resultsList.innerHTML = "";
      if (!users.length) {
        resultsList.innerHTML = `<p class="p-4 text-sm text-gray-500 text-center">No accounts found.</p>`;
      } else {
        users.forEach(user => {
          const div = document.createElement('div');
          div.className = "flex items-center justify-between p-3 hover:bg-gray-100 transition border-b last:border-0";

          div.innerHTML = `
        <div class="flex items-center gap-3 cursor-pointer"
             onclick="window.location.href='profile?id=${user.id}'">
          <img src="${user.profilePic || 'https://via.placeholder.com/40'}"
               class="w-10 h-10 rounded-full object-cover">
          <div>
            <p class="font-bold text-sm text-gray-800">${user.firstName || 'User'} ${user.lastName || ''}</p>
            <p class="text-xs text-gray-500">View Profile</p>
          </div>
        </div>
        ${role === "admin" ? `
        <button class="text-xs px-3 py-1 rounded bg-red-500 text-white hover:bg-red-600">
  Remove
</button>
` : ``}
      `;

          div.querySelector("button")?.addEventListener("click", (e) => {
            removeUser(e, user.id);
          });

          window.removeUser = removeUser;


          resultsList.appendChild(div);
        });
      }
      searchResults.classList.remove('hidden');
    }

    // ===== ADMIN REMOVE FUNCTION =====
    async function removeUser(event, userId) {
      event.stopPropagation();

      if (role !== "admin") {
        alert("Unauthorized action.");
        return;
      }

      const confirmed = confirm("This will permanently remove the user. Continue?");
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, "students", userId));
        alert("User removed successfully.");
        searchInput.dispatchEvent(new Event("input"));
      } catch (err) {
        console.error("Remove error:", err);
        alert("Failed to remove user.");
      }
    }

    // Close search if clicking outside
    document.addEventListener('click', (e) => {
      if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
        searchResults.classList.add('hidden');
      }
    });

    // Sidebar username load
    window.addEventListener("DOMContentLoaded", async () => {
      const sidebarUserName = document.getElementById("sidebarUserName");
      const uid = sessionStorage.getItem("uid") || localStorage.getItem("uid");
      const role = sessionStorage.getItem("role") || localStorage.getItem("role");

      if (!uid || !role) {
        sidebarUserName.textContent = "Guest";
        return;
      }

      const collectionName = {
        "student": "students",
        "counsellor": "counsellors",
        "moderator": "moderators",
        "admin": "admins"
      }[role] || "students";

      try {
        const docSnap = await getDoc(doc(db, collectionName, uid));
        sidebarUserName.textContent = docSnap.exists() ?
          `${docSnap.data().firstName || ''} ${docSnap.data().lastName || ''}` :
          "Unknown User";
      } catch (err) {
        console.error("Error loading user:", err);
        sidebarUserName.textContent = "Error";
      }
    });
  </script>

</body>

</html>