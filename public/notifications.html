<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">

    <nav class="bg-white border-b sticky top-0 z-50 px-6 py-4">
        <div class="max-w-3xl mx-auto flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800">Notifications</h1>
            <a href="mainpage.html" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition">
                Back to Home
            </a>
        </div>
    </nav>

    <div class="max-w-3xl mx-auto p-6">
        <div id="notificationList" class="space-y-4">
            <div class="flex flex-col items-center justify-center py-20 text-gray-400">
                <p>Loading your notifications...</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, query, where, onSnapshot, doc, deleteDoc, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAlpEfar5odDfV9c2bbmaIpAt5fJJfbez4",
            authDomain: "software-peer-support.firebaseapp.com",
            projectId: "software-peer-support",
            storageBucket: "software-peer-support.firebasestorage.app",
            messagingSenderId: "43088815786",
            appId: "1:43088815786:web:4332760b0fef1b7ae152d3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const uid = localStorage.getItem("uid") || sessionStorage.getItem("uid");

        // 1. Function to Accept Friend (Phase 2 placeholder)
    window.acceptFriend = async (notifId, senderId, senderRole = "student") => {
    try {
        const myUid = localStorage.getItem("uid") || sessionStorage.getItem("uid");
        const myRole = localStorage.getItem("role") || sessionStorage.getItem("role");
        const myCol = myRole === "student" ? "students" : (myRole + "s");
        const targetCol = senderRole === "student" ? "students" : (senderRole + "s");

        // 1. Save friendship for ME
        await setDoc(doc(db, myCol, myUid, "friends", senderId), {
            since: new Date(),
            status: "friend"
        });

        // 2. Save friendship for THEM
        await setDoc(doc(db, targetCol, senderId, "friends", myUid), {
            since: new Date(),
            status: "friend"
        });

        // 3. Delete notification
        await deleteDoc(doc(db, "notifications", notifId));
        
        alert("Friend request accepted!");
    } catch (error) {
        console.error("Error accepting:", error);
    }
};

        // 2. Function to Decline/Delete Friend Request
        window.declineFriend = async (notifId) => {
            if(confirm("Are you sure you want to remove this request?")) {
                try {
                    await deleteDoc(doc(db, "notifications", notifId));
                } catch (error) {
                    console.error("Error declining:", error);
                }
            }
        };

        if (uid) {
            // Added orderBy to show newest notifications first
            const q = query(collection(db, "notifications"), where("to", "==", uid));
            
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById("notificationList");
                list.innerHTML = "";

                if (snapshot.empty) {
                    list.innerHTML = `
                        <div class="bg-white rounded-2xl p-12 text-center border-2 border-dashed border-gray-200">
                            <div class="text-5xl mb-4">ðŸ””</div>
                            <h3 class="text-lg font-bold text-gray-800">All caught up!</h3>
                            <p class="text-gray-500">You don't have any new friend requests right now.</p>
                        </div>
                    `;
                    return;
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const notifId = docSnap.id;

                    const card = document.createElement("div");
                    card.className = "bg-white rounded-2xl p-5 shadow-sm border border-gray-100 flex items-center justify-between hover:shadow-md transition-shadow duration-200";
                    
                    if (data.type === "friend_request") {
                        card.innerHTML = `
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-lg">
                                    ${data.fromName.charAt(0)}
                                </div>
                                <div>
                                    <p class="text-gray-900 font-medium">
                                        <span class="font-bold text-blue-600">${data.fromName}</span> sent you a friend request.
                                    </p>
                                    <p class="text-xs text-gray-400 mt-0.5">Wants to connect with you</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="acceptFriend('${notifId}', '${data.from}')" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-sm transition">
                                    Accept
                                </button>
                                <button onclick="declineFriend('${notifId}')" 
                                    class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-xl text-sm font-bold transition">
                                    Decline
                                </button>
                            </div>
                        `;
                    }
                    list.appendChild(card);
                });
            });
        } else {
            window.location.href = "index.html";
        }
    </script>
</body>
</html>